@page "/"
@implements IDisposable
@inject ISolacePublisherClient PublisherClient
@inject MessageHistory MessageHistory
@inject IJSRuntime JS

<PageTitle>Solace Publisher</PageTitle>

<div class="publisher-page">
    <header class="hero">
        <p class="kicker">Solace PubSub+ / Publisher</p>
        <h1 tabindex="-1">Publisher Console</h1>
    </header>

    <section class="grid">
        <article class="panel connection">
            <h2>Establish Connection</h2>
            <p class="status @StatusClass">@Connection.Status</p>
            @if (!string.IsNullOrWhiteSpace(Connection.Details))
            {
                <p class="details">@Connection.Details</p>
            }

            <div class="action-row">
                <button type="button" class="action connect" @onclick="ConnectAsync" disabled="@(!CanConnect)">Connect</button>
                <button type="button" class="action disconnect" @onclick="DisconnectAsync" disabled="@(!CanDisconnect)">Disconnect</button>
                <button type="button" class="action loss" @onclick="SimulateLossAsync" disabled="@(!CanSimulateLoss)">Simulate Link Loss</button>
            </div>

            <div class="field-grid">
                <label>
                    Broker URL
                    <input value="@PublisherClient.Options.Host" readonly />
                </label>
                <label>
                    Message VPN
                    <input value="@PublisherClient.Options.VpnName" readonly />
                </label>
                <label>
                    Client Username
                    <input value="@PublisherClient.Options.Username" readonly />
                </label>
            </div>
        </article>

        <article class="panel composer">
            <h2>Compose Message</h2>
            <form @onsubmit="PublishAsync">
                <label>
                    Topic
                    <input @bind="_topic" @bind:event="oninput" placeholder="solace/test/messages" />
                </label>
                <label>
                    Payload
                    <textarea @bind="_payload" @bind:event="oninput" placeholder="Send JSON, text, or event snippets."></textarea>
                </label>
                <div class="composer-actions">
                    <button class="send" type="submit" disabled="@(!CanPublish)">@ButtonText</button>
                    <button class="ghost" type="button" @onclick="UseJsonTemplate" disabled="@_isSending">Use JSON template</button>
                </div>
                @if (!string.IsNullOrWhiteSpace(_lastResult))
                {
                    <p class="result">@_lastResult</p>
                }
            </form>
        </article>

        <article class="panel timeline">
            <div class="panel-top-row">
                <h2>Recent Outbound Events (Last 20)</h2>
                <button type="button" class="ghost" @onclick="ClearHistory">Clear</button>
            </div>

            @if (_messages.Count == 0)
            {
                <p class="empty">No outbound events yet.</p>
            }
            else
            {
                <ul>
                    @foreach (var message in _messages.Take(20))
                    {
                        <li class="@CardClass(message)">
                            <div class="meta">
                                <span>@message.Direction</span>
                                <span>@message.TimestampUtc.ToLocalTime().ToString("HH:mm:ss")</span>
                            </div>
                            <p class="topic">@message.Topic</p>
                            <p class="payload">@message.Payload</p>
                            <p class="details">@message.Details</p>
                        </li>
                    }
                </ul>
            }
        </article>
    </section>
</div>

@code {
    private IReadOnlyList<MessageRecord> _messages = [];
    private string _topic = string.Empty;
    private string _payload = string.Empty;
    private string _lastResult = string.Empty;
    private bool _isSending;
    private bool _isConnectionBusy;

    private ConnectionSnapshot Connection => PublisherClient.Connection;
    private string StatusClass => Connection.IsConnected ? "online" : "offline";
    private string ButtonText => _isSending ? "Publishing..." : "Publish Message";
    private bool CanConnect => !_isConnectionBusy && !Connection.IsConnected;
    private bool CanDisconnect => !_isConnectionBusy && Connection.IsConnected;
    private bool CanSimulateLoss => !_isConnectionBusy && Connection.IsConnected;
    private bool CanPublish => !_isSending && Connection.IsConnected;

    protected override void OnInitialized()
    {
        _topic = PublisherClient.Options.DefaultPublishTopic;
        _messages = MessageHistory.Snapshot;

        MessageHistory.Changed += OnHistoryChanged;
        PublisherClient.ConnectionChanged += OnConnectionChanged;
    }

    public void Dispose()
    {
        MessageHistory.Changed -= OnHistoryChanged;
        PublisherClient.ConnectionChanged -= OnConnectionChanged;
    }

    private async Task ConnectAsync()
    {
        _isConnectionBusy = true;
        try
        {
            var success = await PublisherClient.ConnectAsync();
            _lastResult = success ? "Connected." : "Connect failed. Check status for details.";
        }
        finally
        {
            _isConnectionBusy = false;
        }
    }

    private async Task DisconnectAsync()
    {
        _isConnectionBusy = true;
        try
        {
            var success = await PublisherClient.DisconnectAsync();
            _lastResult = success ? "Disconnected." : "Disconnect failed. Check status for details.";
        }
        finally
        {
            _isConnectionBusy = false;
        }
    }

    private async Task SimulateLossAsync()
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Drop the Solace session without graceful disconnect?");
        if (confirmed)
        {
            _isConnectionBusy = true;
            try
            {
                var success = await PublisherClient.SimulateConnectionLossAsync();
                _lastResult = success ? "Connection dropped. Use Connect to re-establish." : "Unable to drop connection.";
            }
            finally
            {
                _isConnectionBusy = false;
            }
        }
    }

    private async Task PublishAsync()
    {
        _isSending = true;

        try
        {
            var success = await PublisherClient.PublishAsync(_topic, _payload);
            _lastResult = success ? "Message sent." : "Publish failed. Check status for details.";
            if (success)
            {
                _payload = string.Empty;
            }
        }
        finally
        {
            _isSending = false;
        }
    }

    private void UseJsonTemplate()
    {
        _payload = "{\n  \"event\": \"sample\",\n  \"sentAt\": \"" + DateTimeOffset.UtcNow.ToString("O") + "\"\n}";
    }

    private void ClearHistory() => MessageHistory.Clear();

    private static string CardClass(MessageRecord record) => record.Success ? "ok" : "fail";

    private void OnHistoryChanged()
    {
        _ = InvokeAsync(() =>
        {
            _messages = MessageHistory.Snapshot;
            StateHasChanged();
        });
    }

    private void OnConnectionChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }
}
